---
title: "Methods developement to capture time shift in the age-specific transmission dynamics"
output:
  html_document:
    df_print: paged
---

```{r, echo=FALSE}
library(data.table)
library(ggplot2)
library(ggpubr)

outdir.full <- '/Users/melodiemonod/Box\ Sync/2021/phyloflows/'
```

```{r, echo=FALSE}
load(file.path(outdir.full, 'MRC_FALSE_OnlyHTX_TRUE_threshold_0.5', 'stanin_MRC_FALSE_OnlyHTX_TRUE_threshold_0.5.RData'))
```

## Data

As presented in the last report, we use heterosexual source-recipient pairs enrolled in RCCS in round R15-R16 and R17-R18 identified by Ratmann et al. (2019) accounting for a number of pairs:
```{r, echo=FALSE}
nrow(pairs)
```

The number of source-recipient pairs stratified by sex are
```{r, echo=FALSE}
tab <- pairs[, list(count = .N), by = c('sex.SOURCE', 'sex.RECIPIENT')]
knitr::kable(tab)
```

and by cohort round
```{r, echo=FALSE}
tab <- pairs[, list(count = .N), by = c('cohort_round.SOURCE', 'cohort_round.RECIPIENT')]
knitr::kable(tab)
```

### Date at infection recipient 
We first look at the date at infection of the source and recipient by cohort round. And here we indicate January 2015 by a dashed vertical line.

```{r, echo=FALSE, out.width="70%", fig.show='hold', fig.align='centre'}
date_implementation_UTT = as.Date('2015-01-01')
plot_hist_time_infection(copy(pairs), date_implementation_UTT)
```

We observe that the date at infection of the recipient extends from years 1998 to 2018.


### Age- and sex- specific transmission dynamics
Let us explore the age-specific transmission dynamics stratified by the direction of transmission. We indicate on the y-axis the age of the source when he/she infected the recipient and on the x-axis the age of the recipient when he/she was infected by the source. We refer to those two ages in the following by age at transmission (for the source) and age at infection (for the recipient). Every source-recipient pair is indicated by a dot. 

```{r, echo=FALSE, out.width="40%", fig.show='hold', fig.align='centre'}
plot <- file.path(outdir.full, 'MRC_FALSE_OnlyHTX_TRUE_threshold_0.5', 'AgeInfection_AllPairs_FM.png')
knitr::include_graphics(plot)

plot <- file.path(outdir.full, 'MRC_FALSE_OnlyHTX_TRUE_threshold_0.5', 'AgeInfection_AllPairs_MF.png')
knitr::include_graphics(plot)
```

Note that this plot include pairs for which the recipient has been infected somewhere from 1998 to 2018. We then wonder whether the age-specific transmission dynamics changed over time and therefore could be further stratified by the date at infection of the recipient. Empirically, we look at the plot above again but this time coloring the pairs for which the source infected the recipient before 2015 in blue and after 2015 in red.

```{r, echo=FALSE, out.width="40%", fig.show='hold', fig.align='centre'}
plot <- file.path(outdir.full, 'MRC_FALSE_OnlyHTX_TRUE_threshold_0.5', 'AgeInfection_DateInfectionRecipient_FM.png')
knitr::include_graphics(plot)

plot <- file.path(outdir.full, 'MRC_FALSE_OnlyHTX_TRUE_threshold_0.5', 'AgeInfection_DateInfectionRecipient_MF.png')
knitr::include_graphics(plot)
```

Further we can compute the crude credible interval of the age at transmission of the source for each age at infection of the recipient

```{r, echo=FALSE, out.width="60%", fig.show='hold', fig.align='centre'}
plot <- file.path(outdir.full, 'MRC_FALSE_OnlyHTX_TRUE_threshold_0.5', 'AgeInfectionSource_MRC_FALSE_OnlyHTX_TRUE_threshold_0.5.png')
knitr::include_graphics(plot)

```

Looking at the Female to Male direction, we observe that there might be a shift over time, with women getting infected from older men than before. No shift can be easily observed for the Male to Female direction.


## Methods

Xi et al. (2021) investigated the age-specific transmission dynamics for the Male to Female and Female to Male directions considering all pairs enrolled in the R15-R16 cohorts together. Here we extend her model by adding another dimension: the date at infection of the recipient.
Let us denote by $y_{a,b,t}^{D}$ the number of source-recipient pairs observed in the direction $D$ for which the source was infected at age $a$ and the recipient was infected at age $b$ and at date $t$, where
$$D \in \{\text{Male} \rightarrow \text{Female}, \text{Female} \rightarrow \text{Male}\}$$
$$a, b \in \mathcal{A} = \{15, 16, \dots, 50\}$$
$$b \in \mathcal{B} = \{15, 16, \dots, 50\}$$
$$t \in \mathcal{T} = \{1998, 1999, \dots, 2018\}$$
We use a Poisson point process to model the count of pairs, 
\begin{align}
y_{a,b,t}^D &\sim \text{Poisson}(\lambda_{a,b,t}^{D})\\
\log \lambda_{a,b,t}^{D} &= \mu + \nu \; \mathbb{1}_{D = \text{Male} \rightarrow \text{Female}} + f^{D}(a,b,t), 
\end{align}

We model the three-dimensional random function $f^{D}(a,b,t)$ independently for each direction $D$. We use a zero mean low-rank Gaussian Process projected by regularized B-Splines, as proposed by Monod et al. (2021), 
$$
f^{D}(a,b,t) \sim \mathcal{GP}\big(0, (B_1)^T K_{\beta}^{D} (B^3 \otimes B^2) \big)
$$
where $B_1, B_2$ and $B_3$ are matrices of B-spline basis functions over the space on which the age at infection of the source is defined $\mathcal{A}$, on which the age at infection of the recipient is defined $\mathcal{B}$ and on which the date at infection of the recipient is defined $\mathcal{T}$. $K_{\beta}^{D}$ is a covariance matrix evaluated with a squared exponential kernel function on the indices of the B-splines basis functions and parametrised with scale-variance $\alpha_D$ and dimension-specific length-scale $\rho_1^D. \rho_2^D$ and $\rho_3^D$.

B-splines are a popular choice for non-parametric modelling, due to their continuity properties, ensuring smoothness of the fitted surface. In our context, using a non-parametric smoothing method ensure that the model borrows information across the 3 dimensions which is essential given the low number of pairs observed.

<!-- Several statistical considerations still have to be considered including: -->
Note, that for now we do not include sampling probabilities of the pairs (as in Xi et al.).
<!-- * Because we have very few pairs, we need to stratify the analysis by time periods. The question then is, are we assuming that the the gathered pairs are representative for every time point over each time period or they represent the sum of all pairs of transmission over the period. In one case the pairs will estimate lambda for one time point, in the latter for the sum of time points. In the results we assumed the former -->

## Results 
We show the observed pairs with grey dots and by color the estimated median of the transmission intensity $\lambda$,
```{r, echo=FALSE, out.width="60%", fig.show='hold', fig.align='centre'}
plot <- file.path(outdir.full, 'MRC_FALSE_OnlyHTX_TRUE_threshold_0.5', 'gp_211207-11854', 'gp_211207-11854-intensity_transmission.png')
knitr::include_graphics(plot)
```

<!-- Note that the color scale of the intensities is similar for all time periods such that the the intensity for one time period is not relative to the transmissions observed over this time period but over all the period. We could look at this plot again, this time using a specific color scale for each time period and direction, -->

<!-- ```{r, echo=FALSE, out.width="60%", fig.show='hold', fig.align='centre'} -->
<!-- plot <- file.path(outdir.full, 'MRC_FALSE_OnlyHTX_TRUE_threshold_0.5', 'gp_211207-11854', 'gp_211207-11854-intensity_transmission_idt.png') -->
<!-- knitr::include_graphics(plot) -->
<!-- ``` -->

We see here again that there might be shift from 2015 in the XX direction. Let us explore further by plotting on the y-axis the average age at transmission of the source,

```{r, echo=FALSE, out.width="60%", fig.show='hold', fig.align='centre'}
plot <- file.path(outdir.full, 'MRC_FALSE_OnlyHTX_TRUE_threshold_0.5', 'gp_211207-11854', 'gp_211207-11854-MeanAgeSource_ByAgeRecipient.png')
knitr::include_graphics(plot)
```

We indicated with a shaded area the surface on which we observe data at any point in time, such that predictions outside of the shaded area are extrapolations.

Let's plot this again but this time keeping only three dates and adding the credible intervals

```{r, echo=FALSE, out.width="60%", fig.show='hold', fig.align='centre'}
plot <- file.path(outdir.full, 'MRC_FALSE_OnlyHTX_TRUE_threshold_0.5', 'gp_211207-11854', 'gp_211207-11854-MeanAgeSource_ByAgeRecipient_withCI.png')
knitr::include_graphics(plot)
```

We conclude that in the Female to Male direction:

* We don't have enough data to infer the age-specific transmission dynamics in the Female to Male direction when the female recipient is older than 40.
* in 2015, we observed that male are getting infected by older male than before 


We conclude that in the Male to Female direction:

* We don't have enough data to infer the age-specific transmission dynamics in the Male to Female direction when the female recipient is older than 40.
* in 2015, we observed that female infected after 30 are getting infected by older male than before 
albeit those results are not statistically significant.

Albeit non of those results are significant. 


## References 
Xi et al. Inferring the sources of HIV infection in Africa from deepsequence data with semi-parametric Bayesian Poisson flow models, https://arxiv.org/pdf/2110.12273.pdf (2021)

Monod et al. Regularised B-splines projected Gaussian Process priors to estimate time-trends of age-specific COVID-19 deaths related to vaccine roll-out, http://arxiv.org/abs/2106.12360. (2021) 

Ratmann et al. Inferring HIV-1 transmission networks and sources of epidemic spread in Africa with deep-sequence phylogenetic analysis, https://www.nature.com/articles/s41467-019-09139-4 (2019)

