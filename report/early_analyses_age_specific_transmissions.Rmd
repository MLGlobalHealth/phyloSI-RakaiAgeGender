---
title: "Age- and sex-specific transmissions in Rakai"
output:
  html_document:
    df_print: paged
---

```{r, echo=FALSE}
library(data.table)
library(ggplot2)
library(ggpubr)

outdir.full <- '/Users/melodiemonod/Box\ Sync/2021/phyloflows/'
```

```{r, echo=FALSE}
load(file.path(outdir.full, 'MRC_TRUE_OnlyHTX_TRUE_threshold_0.5', 'stanin_MRC_TRUE_OnlyHTX_TRUE_threshold_0.5.RData'))
dchain <- as.data.table(dchain)
chains <- dchain[, .(H1, H2, LINK_12, LINK_21, SCORE_LINKED, SCORE_DIR_12, SCORE_DIR_21)]
```

## Transmission networks

We use the algorithm proposed by Ratmann et al. (2019), on the sequences from individual enrolled in RCSS round R15-R16 and R17-R18 and in MRC. We obtain structure the groups of patients into pairs. Each pair is associated with a score indicating how likely a transmission occurred between the two individuals.  The total number of pairs is
```{r, echo=FALSE}
nrow(chains)
```
We can show for example the first 10 pairs,
```{r, echo=FALSE}
knitr::kable(chains[1:10])
```

Interestingly, the same individuals can be included in different pairs. Considering all the pairs together, we can therefore re-constitute transmission networks involving multiple pairs. We find the following number of transmission networks,
```{r, echo=FALSE}
length(unique(dchain$IDCLU))
```
The number of individuals included in the transmission networks varies from 
```{r, echo=FALSE}
range(dchain$CLU_SIZE)
```
as an histogram,
```{r, echo=FALSE, out.width="50%",  fig.align='centre'}
tmp <- unique(dchain[, .(IDCLU, CLU_SIZE)])
ggplot(tmp, aes(x = CLU_SIZE)) + 
  geom_histogram() + 
  scale_x_continuous(breaks = min(dchain$CLU_SIZE):max(dchain$CLU_SIZE)) + 
  labs(x = 'number of individuals in transmission network')
```

Let us plot a few of them,

```{r, echo=FALSE, out.width="50%",  fig.align='centre'}
p <- file.path(outdir.full, 'plot-transmission-networks.png')
knitr::include_graphics(p)

```




## Focus on likely source-recipient pairs enrolled in RCSS

Let us focus on heterosexual pairs with a score of at least 0.5, amounting to a total of pairs, 
```{r, echo=FALSE}
nrow(pairs.all)
```

### Source-recipient pairs stratified by program

We see that individuals involved in likely source-recipient pairs are both from the RCSS cohort and MRC programs, 
```{r, echo=FALSE}
tab <- pairs.all[, list(count = .N), by = c('cohort.SOURCE', 'cohort.RECIPIENT')]
knitr::kable(tab)
```

We restrict our analysis to pairs enrolled in RCSS for which and obtain a total number of pairs,
```{r, echo=FALSE}
load(file.path(outdir.full, 'MRC_FALSE_OnlyHTX_TRUE_threshold_0.5', 'stanin_MRC_FALSE_OnlyHTX_TRUE_threshold_0.5.RData'))
nrow(pairs)
```


### Source-recipient pairs stratified by sex and cohort round

The number of source-recipient pairs stratified by sex are
```{r, echo=FALSE}
tab <- pairs[, list(count = .N), by = c('sex.SOURCE', 'sex.RECIPIENT')]
knitr::kable(tab)
```

and by cohort round
```{r, echo=FALSE}
tab <- pairs[, list(count = .N), by = c('cohort_round.SOURCE', 'cohort_round.RECIPIENT')]
knitr::kable(tab)
```


## Time of infection of sources and recipients

We define the time of infection as one year before the time of first positive test.

We plot the time of infection of the source and recipient by cohort round. And here we indicate January 2014 by a dashed vertical line.

```{r, echo=FALSE, out.width="70%", fig.show='hold', fig.align='centre'}
date_implementation_UTT = as.Date('2014-01-01')
plot_hist_time_infection(copy(pairs), date_implementation_UTT)

```

A key date to investigate age shift over time, when UTT was implemented in Rakai. Large declines in incidence among women were found afterwards https://www.croiconference.org/abstract/rapidly-declining-hiv-incidence-among-men-and-women-in-rakai-uganda/. Let us hypothesised two dates for the shift: January 2014 and January 2015. 

Let us look at the number of pairs stratified by whether the recipient was infected before and after UTT was implemented.

Using January 2014 as UTT implementation date:

```{r, echo=FALSE}
date_implementation_UTT = as.Date('2014-01-01')
pairs[, date_infection_before_UTT.RECIPIENT := date_infection.RECIPIENT <= date_implementation_UTT]
tab <- pairs[, list(count = .N), by = c('sex.SOURCE', 'sex.RECIPIENT', 'date_infection_before_UTT.RECIPIENT')]
knitr::kable(tab)
```

Using January 2015 as UTT implementation date:

```{r, echo=FALSE}
date_implementation_UTT = as.Date('2015-01-01')
pairs[, date_infection_before_UTT.RECIPIENT := date_infection.RECIPIENT <= date_implementation_UTT]
tab <- pairs[, list(count = .N), by = c('sex.SOURCE', 'sex.RECIPIENT', 'date_infection_before_UTT.RECIPIENT')]
knitr::kable(tab)
```



## Age at infection of sources and recipients

Next, we explore the age at infection of the sources and recipients. We present two plots:

* the age at infection of the recipient against the age at infection of the source for the Male to Female and Female to Male direction.
* the crude credible interval of the age at infection of the source for each 5 year age bands of the age of the recipient

Additionally, we show by color whether the date at infection of the recipient was before or after UTT was implemented.

Using January 2014 as UTT implementation date:

```{r, echo=FALSE, out.width="50%", fig.show='hold', fig.align='centre'}
date_implementation_UTT = as.Date('2014-01-01')
pairs[, date_infection_before_UTT.RECIPIENT := date_infection.RECIPIENT <= date_implementation_UTT]
p <- plot_age_infection_source_recipient(pairs[sex.SOURCE == 'M' & sex.RECIPIENT == 'F'], 'Male -> Female', 'MF')
p2 <- plot_age_infection_source_recipient(pairs[sex.SOURCE == 'F' & sex.RECIPIENT == 'M'], 'Female -> Male', 'FM')

 p2[[3]]; p[[3]];

```

```{r, echo=FALSE, out.width="50%", fig.show='hold', fig.align='centre'}
p <- plot_CI_age_infection(pairs)

p

```



Using January 2015 as UTT implementation date:

```{r, echo=FALSE, out.width="50%", fig.show='hold', fig.align='centre'}
date_implementation_UTT = as.Date('2015-01-01')
pairs[, date_infection_before_UTT.RECIPIENT := date_infection.RECIPIENT <= date_implementation_UTT]
p <- plot_age_infection_source_recipient(pairs[sex.SOURCE == 'M' & sex.RECIPIENT == 'F'], 'Male -> Female', 'MF', outdir.lab)
p2 <- plot_age_infection_source_recipient(pairs[sex.SOURCE == 'F' & sex.RECIPIENT == 'M'], 'Female -> Male', 'FM', outdir.lab)

p2[[3]]; p[[3]]; 

```

```{r, echo=FALSE, out.width="60%",  fig.align='centre'}
p <- plot_CI_age_infection(pairs)

p

```

